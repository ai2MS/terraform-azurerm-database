#cloud-config
package_update: true
package_upgrade: true

packages:
  - snapd
  - python3
  - python3-pip
  - python3-venv

write_files:
  - path: /root/install-packages.yml
    owner: root:root
    permissions: "0644"
    content: |
      ---
      - name: Install required packages
        hosts: localhost
        remote_user: ${admin_username}
        gather_facts: yes
        become: true

        tasks:
          - name: Install base packages
            apt:
              name:
                - curl
                - unzip
                - gnupg
                - git
                - apt-transport-https
                - ca-certificates
                - lsb-release
              state: present

          - name: Update apt cache
            apt:
              update_cache: yes

          - name: Install microk8s
            snap:
              name: microk8s
              classic: true
              channel: ${microk8s_channel}

          - name: Install helm
            snap:
              name: helm
              classic: true

          - name: Install docker
            snap:
              name: docker

          - name: Install ollama
            shell: curl -fsSL https://ollama.com/install.sh | sh
            args:
              creates: /usr/local/bin/ollama

          - name: Add current user to microk8s group
            user:
              name: "{{ ansible_user_id }}"
              groups: microk8s
              append: true

          - name: Enable microk8s addons
            shell: |
              microk8s status --wait-ready
              microk8s enable dns storage ingress
            args:
              creates: /var/snap/microk8s/current/args/kubelet

          - name: Create kube config directory
            file:
              path: "/home/{{ ansible_user_id }}/.kube"
              state: directory
              owner: "{{ ansible_user_id }}"
              mode: "0755"

          - name: Export microk8s kubeconfig
            shell: |
              microk8s config > /home/{{ ansible_user_id }}/.kube/config
            args:
              creates: "/home/{{ ansible_user_id }}/.kube/config"

          - name: Fix kubeconfig permissions
            file:
              path: "/home/{{ ansible_user_id }}/.kube/config"
              owner: "{{ ansible_user_id }}"
              mode: "0600"

          - name: Create kubectl alias from microk8s
            command: snap alias microk8s.kubectl kubectl
            args:
              creates: /snap/bin/kubectl

          - name: Install kubelogin
            shell: az aks install-cli --install-location /usr/local/bin
            args:
              creates: /usr/local/bin/kubelogin

  - path: /root/show_versions.yml
    owner: root:root
    permissions: "0644"
    content: |
      ---
      - name: Show package versions
        owner: root:root
        permissions: "0644"
        content: |
          ---
          - name: Show package versions
            hosts: localhost
            remote_user: ${admin_username}
            gather_facts: no
            become: false

            tasks:
              - name: Helm version
                shell: "helm version --short || helm version"
                register: helm_version
                ignore_errors: true
              - debug:
                  msg: "{{ helm_version.stdout | default('Helm: not installed') }}"

              - name: kubelogin version
                shell: "kubelogin --version"
                register: kubelogin_version
                ignore_errors: true
              - debug:
                  msg: "{{ kubelogin_version.stdout | default('kubelogin: not installed') }}"

              - name: Azure CLI version
                shell: "az version | grep azure-cli | awk -F'\"' '{print $4}'"
                register: az_version
                ignore_errors: true
              - debug:
                  msg: "{{ az_version.stdout | default('Azure CLI: not installed') }}"

              - name: Git version
                shell: "git --version"
                register: git_version
                ignore_errors: true
              - debug:
                  msg: "{{ git_version.stdout | default('Git: not installed') }}"

              - name: MicroK8s version
                shell: "microk8s version --short || microk8s version"
                register: microk8s_version
                ignore_errors: true
              - debug:
                  msg: "{{ microk8s_version.stdout | default('MicroK8s: not installed') }}"

              - name: Ollama version
                shell: "ollama -v"
                register: ollama_version
                ignore_errors: true
              - debug:
                  msg: "{{ ollama_version.stdout | default('Ollama: not installed') }}"

              - name: Docker version
                shell: "docker --version"
                register: docker_version
                ignore_errors: true
              - debug:
                  msg: "{{ docker_version.stdout | default('Docker: not installed') }}"

              - name: kubectl version
                shell: "kubectl version --client --short || kubectl version --client"
                register: kubectl_version
                ignore_errors: true
              - debug:
                  msg: "{{ kubectl_version.stdout | default('kubectl: not installed') }}"

              - name: Ansible version
                shell: "ansible --version | head -n1"
                register: ansible_version
                ignore_errors: true
              - debug:
                  msg: "{{ ansible_version.stdout | default('Ansible: not installed') }}"

              - name: Python version
                shell: "python3 --version"
                register: python_version
                ignore_errors: true
              - debug:
                  msg: "{{ python_version.stdout | default('Python: not installed') }}"

runcmd:
  - [ echo, "Starting cloud-init runcmd execution..." ]
  - [ systemctl, enable, --now, snapd.socket ]
  - [ echo, "Upgrading pip..." ]
  - [ /usr/bin/python3, -m, pip, install, --upgrade, pip ]
  - [ /usr/bin/python3, -m, pip, config, set, global.disable-pip-version-check, "true" ]
  - [ echo, "Installing ansible and azure cli..." ]
  - [ python3, -m, pip, install, ansible==${ansible_version}, azure-cli==${azure_cli_version} ]
  - [ echo, "Running ansible playbook: install-packages.yml..." ]
  - [ ansible-playbook, /root/install-packages.yml, -v ]
  - [ echo, "Running ansible playbook: show_versions.yml..." ]
  - [ ansible-playbook, /root/show_versions.yml, -v ]
  - [ echo, "Cloud-init runcmd execution finished successfully." ]
