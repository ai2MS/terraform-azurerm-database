#cloud-config
package_update: true
package_upgrade: true

packages:
  - snapd
  - python3
  - python3-pip
  - python3-venv

write_files:
  - path: /root/install-packages.yml
    owner: root:root
    permissions: "0644"
    content: |
      ---
      - name: Install required packages
        hosts: localhost
        remote_user: ${admin_username}
        gather_facts: yes
        become: true

        tasks:
          - name: Install base packages
            apt:
              name:
                - curl
                - unzip
                - gnupg
                - git
					      - apt-transport-https
					      - ca-certificates
					      - lsb-release
              state: present

          - name: Update apt cache
            apt:
              update_cache: yes

          - name: Install microk8s
            snap:
              name: microk8s
              classic: true
              channel: ${microk8s_channel}

          - name: Install helm
            snap:
              name: helm
              classic: true

          - name: Install docker
            snap:
              name: docker

          - name: Install ollama
            shell: curl -fsSL https://ollama.com/install.sh | sh
            args:
              creates: /usr/local/bin/ollama

          - name: Add current user to microk8s group
            user:
              name: "{{ ansible_user_id }}"
              groups: microk8s
              append: true

          - name: Enable microk8s addons
            shell: |
              microk8s status --wait-ready
              microk8s enable dns storage ingress
            args:
              creates: /var/snap/microk8s/current/args/kubelet

          - name: Create kube config directory
            file:
              path: "/home/{{ ansible_user_id }}/.kube"
              state: directory
              owner: "{{ ansible_user_id }}"
              mode: "0755"

          - name: Export microk8s kubeconfig
            shell: |
              microk8s config > /home/{{ ansible_user_id }}/.kube/config
            args:
              creates: "/home/{{ ansible_user_id }}/.kube/config"

          - name: Fix kubeconfig permissions
            file:
              path: "/home/{{ ansible_user_id }}/.kube/config"
              owner: "{{ ansible_user_id }}"
              mode: "0600"

			    - name: Create kubectl alias from microk8s
			      command: snap alias microk8s.kubectl kubectl
			      args:
			        creates: /snap/bin/kubectl

runcmd:
  - [ systemctl, enable, --now, snapd.socket ]
  - [ python3, -m, pip, install, --upgrade, pip ]
  - [ python3, -m, pip, install, ansible==${ansible_version}, azure-cli==${azure_cli_version} ]
  - [ ansible-playbook, /root/install-packages.yml ]
